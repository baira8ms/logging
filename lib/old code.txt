var logging = require("events").EventEmitter;
var fs = require("fs");
var path = require('path');

var loggerEvent = new logging();
var activeLogEvent ='INFO';

var logProperties = JSON.parse(fs.readFileSync(__dirname+"/../properties/logProperties.json",'utf8'));
loggerEvent.on("INFO", function(message){
 	//console.log(process.mainModule.filename);
 	activeLogEvent = 'INFO'
 	logMessage(message);
 });

loggerEvent.on("WARN", function(message){
	activeLogEvent = 'WARN'
	logMessage(message);
});

loggerEvent.on("ERROR", function(message){
	activeLogEvent = 'ERROR'
	logMessage(message);
});


var logMessage = function(message) {
	var levels = ['ERROR', 'WARN', 'INFO'];
	if (levels.indexOf(activeLogEvent) >= levels.indexOf(logProperties.level) ) {
		var dateString = new Date().toString();
		var filename = process.mainModule.filename;
		var logStatement = dateString.substring(0, dateString.indexOf(dateString.split(' ')[5]))+':'+
		filename.substring(filename.lastIndexOf('\\')+1,filename.length)+':'+__function+"():"+
		__line+':'+activeLogEvent+' : '+message +"\n";
		console.log(logStatement);
		if(logProperties.savedToFile === 'Yes'){
			streamingIntoFile(logProperties.fileLocation,logStatement);  	
		}
	}
}

// Getting stack details to find out the method invoker name and line number where it is invoked.
Object.defineProperty(global, '__stack', {
	get: function() {
		var orig = Error.prepareStackTrace;
		Error.prepareStackTrace = function(_, stack) {
			return stack;
		};
		var err = new Error;
		Error.captureStackTrace(err, arguments.callee);
		var stack = err.stack;
		Error.prepareStackTrace = orig;
		return stack;
	}
});

Object.defineProperty(global, '__line', {
	get: function() {
		return __stack[4].getLineNumber(); 
	}
});

Object.defineProperty(global, '__function', {
	get: function() {
		return __stack[4].getFunctionName();
	}
});

if(global.logFileName === null || global.logFileName === undefined)
{

	global.logFileName = "application.log";
	global.filePath = "";
}

// Writing into log file
var streamingIntoFile = function(userDefinedPath, content)	{
	console.log("log file name: "+global.logFileName);

	if(userDefinedPath !== "" && userDefinedPath !== " "){
		global.filePath = __dirname+userDefinedPath+global.logFileName+".txt";
	}else{
		global.filePath = __dirname+"\\"+global.logFileName+".txt";
	}

	fs.exists(global.filePath, function (err) {
			if(!err){
				if(global.filePath.length < 10000){
					fs.appendFile(global.filePath ,content,function(err){
						if(err){
							console.log(err);
						}
					});
				}else{
					global.logFileName = new Date().getTime().toString();
					fs.writeFile(global.filePath ,content,function(err){
						if(err){
							console.log(err);
						}
					});
				}
			}else{
				global.logFileName = new Date().getTime().toString();
				fs.writeFile(global.filePath ,content,function(err){
					if(err){
						console.log(err);
					}
				});
			}
		});
}

module.exports = loggerEvent;